# SMBX 38A è¿è¡Œæ—¶åŠŸèƒ½å¢žè¡¥ç¨‹åº

è¯¥å·¥ç¨‹æœ‰ä¸¤ä¸ªç›®çš„ï¼š

1. è§„èŒƒåŒ– 38a ç‰ˆçš„ SMBX æ¸¸æˆä½“éªŒæµç¨‹ï¼Œæ–­æŽ‰åŽŸå¼•æ“Žæœ¬èº«çš„ç¼–è¾‘å™¨åŠŸèƒ½ï¼›
2. å¢žå¼º 38a ç‰ˆ SMBX æ¸¸æˆçš„ä½“éªŒï¼ˆå¼ºåˆ¶å…¨å±å¹¶ä¿®æ­£å…¨å±è¡¨çŽ°ï¼Œæ‰©å±•å›¾å½¢æ¸²æŸ“èƒ½åŠ›ï¼ˆæ¯”å¦‚æä¾›å±å¹•åŽå¤„ç†ï¼‰ç­‰åŠŸèƒ½ï¼‰

## å¼€å‘çŽ¯å¢ƒé…ç½®

éœ€è¦é¢„å…ˆå®‰è£…ï¼š

- ninjaï¼ˆéœ€è¦é…ç½®åœ¨çŽ¯å¢ƒå˜é‡é‡Œï¼‰
- cmakeï¼ˆ3.24+ ç‰ˆæœ¬ï¼‰
- visual studio codeï¼ˆå« cmake toolsã€clangd æ’ä»¶ï¼‰
- visual studio 2019 **æˆ–** visual studio 2022ï¼ˆé¡¹ç›®éœ€è¦ä½¿ç”¨ msvc ç¼–è¯‘ï¼Œä¸” c++ ç‰ˆæœ¬è¦é«˜äºŽ 20ï¼‰ã€‚

### å·¥ç¨‹æ–‡ä»¶åŠç¼–è¯‘

å®‰è£…å¥½ä¸Šè¿°è½¯ä»¶å’Œå·¥å…·é“¾åŽä½¿ç”¨ visual studio code æ‰“å¼€ `./smbx-enginex.code-workspace`ï¼Œç¼–è¯‘å™¨é€‰æ‹© `Visual Studio Community 2022/2019 Release - x86`

![image-20250712202112858](./doc/img/README/image-20250712202112858.png)

åœ¨ä¾§è¾¹æ é€‰æ‹©â€œç”Ÿæˆæ‰€æœ‰é¡¹ç›®â€

![image-20250712202540024](./doc/img/README/image-20250712202540024.png)

### æž„å»ºåˆ¶å“

å¦‚æžœæˆåŠŸæž„å»ºï¼Œæž„å»ºåˆ¶å“è§ ./build ç›®å½•ã€‚

- `./build/engine-extension/engine-extension.dll`ï¼šè¯¥æ–‡ä»¶æ˜¯æ‰©å±•å¼•æ“Žçš„æ ¸å¿ƒåº“ã€‚
- `./build/main/main.exe`ï¼šè¯¥æ–‡ä»¶æ˜¯æ‰©å±•å¼•æ“Žçš„å¯åŠ¨å™¨ã€‚
- `./build/redirection/redirection.dll`ï¼šè¯¥æ–‡ä»¶è´Ÿè´£åœ¨ engine-ext.exe å¯åŠ¨æ—¶æ‹‰èµ·æ‰©å±•å¼•æ“Žã€‚
- `./build/shaders/*.cso`ï¼šè¿™äº› cso æ–‡ä»¶æ˜¯ `./engine-extension/shaders/` ä¸‹æ‰€æœ‰ç€è‰²å™¨çš„ç¼–è¯‘åˆ¶å“ï¼Œç€è‰²å™¨çš„ç±»åž‹åˆ¤å®šéµå¾ªå¦‚ä¸‹è§„åˆ™ï¼š
  - ä»¥ `_vs` ç»“å°¾çš„ã€ä»¥ `vert` å¼€å¤´çš„ã€ä»¥ `_v` ç»“å°¾çš„ä¼šåˆ¤å®šä¸ºé¡¶ç‚¹ç€è‰²å™¨ï¼Œå…¥å£å‡½æ•°ä¸º main
  - ä»¥ `_ps` ç»“å°¾çš„ã€ä»¥ `pix` å¼€å¤´çš„ã€ä»¥ `_p` ç»“å°¾çš„ä¼šè¢«åˆ¤å®šä¸ºåƒç´ ç€è‰²å™¨ï¼Œå…¥å£å‡½æ•°ä¸º main
  - ä»¥ `_cs` ç»“å°¾çš„ã€ä»¥ `_c` å¼€å¤´çš„ä¼šè¢«åˆ¤å®šä¸ºè®¡ç®—ç€è‰²å™¨ï¼Œå…¥å£å‡½æ•°ä¸º main

### æˆå“ç›®å½•ç»“æž„

å¤§ä½“ç»“æž„å‚è€ƒ `./template` ç›®å½•ï¼Œä»¥ä¸‹**æ­¥éª¤ä»¥è¯¥ç›®å½•ä½œä¸ºæ ¹ç›®å½•**ï¼š

- å°†æž„å»ºåˆ¶å“ä¸­çš„ main.exe å’Œ engine-extension.dll æ”¾åˆ° `./` ç›®å½•ï¼ˆæ ¹ç›®å½•ï¼‰ä¸‹ã€‚
- å°† smbx38a editor æ”¾åˆ° `./engine` ç›®å½•ä¸‹ï¼Œå¹¶åˆ é™¤åŽŸ editor.exeï¼ˆsmbx.exeï¼‰ã€‚æˆ‘ä»¬ä½¿ç”¨ç›®å½•ä¸­åŽŸæœ¬æ”¾æœ‰çš„ä¸€ä¸ªæ‰“äº†è¡¥ä¸çš„ engine-ext.exe ä½œä¸º smbx æœ¬ä½“çš„å¯åŠ¨ç¨‹åºã€‚
- å°†æž„å»ºåˆ¶å“ä¸­çš„ redirection.dll æ”¾åˆ° `./engine` ç›®å½•ä¸‹ã€‚
- å°†æž„å»ºåˆ¶å“ä¸­çš„ç€è‰²å™¨ç¼–è¯‘ç»“æžœ ï¼ˆ`*.cso`ï¼‰æ”¾åˆ° `./assets/shaders/`ç›®å½•ä¸‹ã€‚
- å°†æ¸¸æˆå…³å¡æ”¾åˆ° `./assets/game` ç›®å½•ä¸‹ã€‚å¹¶ç”¨è®°äº‹æœ¬ç¼–è¾‘è¯¥ç›®å½•ä¸‹çš„ main æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åˆ†ä¸ºä¸¤è¡Œï¼Œç¬¬ä¸€è¡Œä¸ºä»Ž `./`ç›®å½•åˆ°å…³å¡æ–‡ä»¶çš„è·¯å¾„ï¼Œç¬¬äºŒè¡Œä¸ºæ‰“å¼€æ¸¸æˆåŽçš„çª—å£åï¼ˆæ‰©å±•å¼•æ“Žé è¿™ä¸ªå®šä½åˆ° smbx çš„ä¸»çª—å£å¯¹è±¡ï¼Œå¦‚æžœä¸å¡«ç¬¬äºŒè¡Œçª—å£ååˆ™é»˜è®¤ä¸º `Super Mario Bros. X by 38A - Version 1.4.5`ï¼‰ã€‚

é…ç½®å¥½ä¸Šè¿°ç»“æž„åŽæ‰“å¼€æ ¹ç›®å½•çš„ main.exe å³å¯è¿›å…¥æ¸¸æˆã€‚

## é¡¹ç›®ç»“æž„

è¯¥é¡¹ç›®ç”±å››ä¸ªå­å·¥ç¨‹ç»„æˆï¼š

- Detours ä¸ºå¾®è½¯æä¾›çš„ Hook å·¥å…·
- engine-extension ä¸ºå¢žè¡¥ç¨‹åºçš„ä¸»ä½“
- main ä¸ºå…¥å£ç¨‹åº
- redirection ç”¨äºŽå…³è” ./engine/engine-ext.exe å’Œ ./engine-extension.dll

### Main

å­å·¥ç¨‹ main åªåšä¸¤ä»¶äº‹ï¼š

1. æ‹‰èµ· ./engine/engine-ext.exeï¼ˆSMBX æºç¨‹åºï¼‰ï¼Œå¹¶å°†å…¥å£åœºæ™¯ä½œä¸ºå‚æ•°ä¼ é€’ç»™ SMBXã€‚
   ```cpp
   /* ... */
       if (CreateProcess(
           NULL,
           x,
           NULL,
           NULL,
           false,
           dwFlags,
           (LPVOID)chNewEnv,
           TEXT("./engine"),
           &si,
           &pi
       )) return 0;
   /* ... */
   ```
   
   

2. ä¸ºæ‹‰èµ·çš„ç¨‹åºè®¾ç½® ENGINE_PASSPORT çŽ¯å¢ƒå˜é‡ï¼ˆè¯¥çŽ¯å¢ƒå˜é‡ç”¨äºŽé˜»æ–­ç›´æŽ¥æ‰“å¼€ engine-ext.exe çš„è¡Œä¸ºï¼Œè¯¥é˜»æ–­é€»è¾‘å†™åœ¨ redirection.dll ä¸­ï¼‰ã€‚
   ```cpp
   /* ... */
       auto chNewEnv = new TCHAR[envSize]{ 0 };
       lpszCurrentVariable = (LPTSTR)chNewEnv;
       if (FAILED(StringCchCopy(lpszCurrentVariable, envSize, TEXT("ENGINE_PASSPORT=")))) return -3;
       lpszCurrentVariable += lstrlen(lpszCurrentVariable);
   /* ... */
   ```



### Redirection

å­å·¥ç¨‹ redirection ç”¨äºŽé“¾æŽ¥ engine-ext.exe å’Œ engine-extension.dll

è¯¥é¡¹ç›®æ ¹ç›®å½•ä¸­çš„ **./template/engine/engine-ext.exe** æ˜¯æ‰“äº†è¡¥ä¸çš„ï¼ˆå¯ä»¥ç”¨ CFF Explorerï¼‰ï¼Œå®ƒè¢«åŽæœŸæ·»åŠ äº†ä¸€ä¸ªå¯¹åŒç›®å½•ä¸‹ redirection.dll æ‰€å¯¼å‡ºçš„åä¸º "_" çš„å‡½æ•°ä¾èµ–ï¼Œè¿™ä½¿å¾— engine-ext.exe æ‰“å¼€æ—¶ä¼šå¯»æ‰¾ redirection.dll å¹¶è¿è¡Œå…¶å…¥å£å‡½æ•°ï¼ˆdllMainï¼‰ã€‚

redirection.dll ä¹Ÿåªå¹²äº†ä¸¤ä»¶äº‹ï¼š

1. æ£€æŸ¥å½“å‰è¿›ç¨‹çš„çŽ¯å¢ƒå˜é‡ ENGINE_PASSPORT æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œè‹¥ä¸æ»¡è¶³ç›´æŽ¥ç»ˆæ­¢è¯¥è¿›ç¨‹ã€‚
   ```cpp
   /* ... */
           TCHAR buffer[256];
           DWORD size = GetEnvironmentVariable(TEXT("ENGINE_PASSPORT"), buffer, 256);
           if (size == 4) {
               auto res = lstrcmp(buffer, TEXT("NONE"));
               if (res) ExitProcess(-3);
           }
   
           else if (size > 0 && size < sizeof(buffer)) {
               auto res = lstrcmp(buffer, PASSPORT);
               if (res) ExitProcess(-1);
           }
           else ExitProcess(-2);
   /* ... */
   ```

2. æ‹‰èµ· engine-extension.dll å¹¶è¿è¡Œå…¶å¯¼å‡ºçš„ engineStart() å‡½æ•°ã€‚

### Engine-extension

è¯¥å­å·¥ç¨‹ä¸ºå¢žè¡¥ç¨‹åºçš„ä¸»ä½“å·¥ç¨‹ã€‚å®ƒç”± redirection.dll æ‹‰èµ·ï¼Œå¹¶å¯¹ SMBX æºç¨‹åºï¼ˆ./engien/engine.exeï¼‰ä¸­ç›¸åº”çš„å‡½æ•°è¿›è¡Œ hook å¤„ç†ã€‚å…¶ä¸»ä½“é€»è¾‘å‚è§ main.cppï¼ˆè™½ç„¶ engine-extension çš„åˆå§‹åŒ–é€»è¾‘åº”è¯¥ä»Ž dllMain.cpp å¼€å§‹ï¼Œä¸è¿‡å¯¹äºŽå…·ä½“çš„ä¸šåŠ¡è¿˜æ˜¯å€¾å‘äºŽå‰¥ç¦»åˆå§‹ç»“æž„ï¼‰ã€‚

#### çº¿ç¨‹å¸ƒè®¾

ä¸ºäº†ä¸å½±å“ SMBX ä¸»ç¨‹åºçš„æ­£å¸¸è¿è¡Œï¼ŒEngine-extension ä¸ºå¢žè¡¥ç¨‹åºå•å¼€äº†ä¸€æ¡çº¿ç¨‹ï¼ˆä¸‹ç§°å¢žè¡¥çº¿ç¨‹ï¼‰ã€‚å¢žè¡¥çº¿ç¨‹å’Œ SMBX ä¸»çº¿ç¨‹çš„åå·®ä¸ä¼šè¶…è¿‡å¤§äºŽä¸€å¸§`ï¼ˆè‹¥æŸä¸ªçº¿ç¨‹å³å°†è¶…è¿‡åˆ™ä¼šè¢«é˜»å¡žï¼Œè¿™æ˜¯ç”±äºŽ D3D9 (smbx æ‰€ä½¿ç”¨) å’Œ D3D11 (å¢žè¡¥ç¨‹åºæ‰€ä½¿ç”¨) éƒ½æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒEngine-extension ä¸ºäº†èŽ·å¾— D3D9 çš„æ¸²æŸ“ç»“æžœå¿…é¡»è¦åœ¨è¯¥å¤„è¿›è¡Œçº¿ç¨‹åŒæ­¥ï¼‰`ã€‚

ç†è®ºä¸Šè¯´ï¼Œæ‰€æœ‰çš„å¢žè¡¥ç¨‹åºé€»è¾‘éƒ½åº”è¯¥åœ¨å¢žè¡¥çº¿ç¨‹ä¸­è¿è¡Œã€‚ä¸ºäº†å®‰å…¨ä¸Šè€ƒè™‘ï¼Œåº”è¯¥å°½é‡å‡å°‘çº¿ç¨‹é—´çš„å¾€æ¥ã€‚

#### ç”Ÿå‘½å‘¨æœŸ

å¢žè¡¥ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸå®Œæ•´åœ°ç½—åˆ—åœ¨ main.cpp ä¸­ï¼š

```cpp
// å¤–æŒ‚å¼•æ“Žå¯åŠ¨ (è¿è¡Œåœ¨ä¸»çº¿ç¨‹)
void MainStart() { /*... æ­¤å¤„æ˜¯ hook é€»è¾‘å’Œå¢žè¡¥æ¨¡å—çš„åˆå§‹åŒ–å·¥ä½œ */ }

// smbx çš„ä¸»å¾ªçŽ¯, ç”± D3d9 çš„ Present å‡½æ•°å¸¦åŠ¨ (è¿è¡Œåœ¨ä¸»çº¿ç¨‹)
// æ‰€ä»¥ D3d9 è®¾å¤‡å®žä¾‹åˆ›å»ºå‰è¿™ä¸ªå‡½æ•°ä¸ä¼šè¿è¡Œ(æ‰€ä»¥å°±åˆšæ‰“å¼€ç¨‹åºè€Œè¨€ä¼šå»¶è¿Ÿä¸€äº›)
void SmbxUpdate() { /*...*/ }

// å¤–æŒ‚å¼•æ“Žä¸»å¾ªçŽ¯(å’Œ smbx ä¸»å¾ªçŽ¯ä¸åœ¨ä¸€ä¸ªçº¿ç¨‹, æ¶‰åŠåˆ°æ•°æ®äº¤äº’æ—¶æ³¨æ„ç«žäº‰é—®é¢˜) (è¿è¡Œåœ¨å¢žè¡¥çº¿ç¨‹)
void MainUpdate(float t) { /*... å¢žè¡¥æ¨¡å—çš„å¸§è½®è¯¢*/ }

// å¤–æŒ‚å¼•æ“Žé”€æ¯å‰æ‰§è¡Œ (è¿è¡Œåœ¨ä¸»çº¿ç¨‹)
void MainEnd() { /* ... è¿˜åŽŸ hook å’Œå¢žè¡¥æ¨¡å—çš„é”€æ¯*/ }
```

#### ä¸šåŠ¡æ¨¡å—

ç›®å‰å¢žè¡¥ç¨‹åºçš„ä¸»ä½“ä¸€å…±åˆ†ä¸ºå‡ ä¸ªå¤§ç±»ï¼ˆæŒ‰æ–‡ä»¶å¤¹åˆ†ï¼‰ï¼šhookã€renderã€utilï¼Œæ‰€æœ‰çš„ä¸šåŠ¡æ¨¡å—æ ¹æ®åŠŸèƒ½ä¸åŒåˆ†åˆ«ç½®äºŽå…¶ä¸­ã€‚

##### hook

hook ä¸»è¦ç®¡ç†å¯¹ smbx æºç¨‹åºä¸­å‡½æ•°çš„ hook å·¥ä½œã€‚ç›®å‰åª hook äº† d3d9 çš„æ‰€æœ‰æŽ¥å£ã€winapi çš„ GetMessage(...)ã€winapi çš„ MessageBoxW(...)ã€winapi çš„ ShowWindow(...)ã€‚

å…¶ä¸­ï¼š

- d3d9 ç”¨æ¥æ‹¦æˆªæ¸²æŸ“ä¿¡æ¯ã€‚
- ShowWindow ç”¨æ¥èŽ·å– smbx çš„ä¸»çª—å£
- MessageBoxW ç”¨æ¥æ‹¦æˆª smbx çš„æç¤ºå¼¹çª—ï¼ˆsmbx æ˜¯æ”¯æŒåœ¨ teascript ä¸­è°ƒç”¨å‡½æ•°å¼¹å‡º msgBox çš„ï¼Œå¹¶ä¸” msgBox ä¼šé˜»å¡ž smbx ä¸»çº¿ç¨‹çš„è¿è¡Œã€‚æˆ‘ä»¬å¯ä»¥èŽ·å¾— msgBox çš„ä¿¡æ¯å®žçŽ°åœ¨ teascript ä¸­è°ƒç”¨å¢žè¡¥ç¨‹åºçš„é€»è¾‘ï¼‰ã€‚

##### render

render æ–‡ä»¶å¤¹ä¸‹ä¸»è¦æ˜¯æ¸²æŸ“æ¨¡å—ï¼Œå…¶ä¸»ä½“å¯è§ render.cppã€‚åœ¨ render.cpp ä¸­ä¹Ÿæ˜Žç¡®åœ°åˆ—å‡ºäº†æ¸²æŸ“æ¨¡å—çš„ç”Ÿå‘½å‘¨æœŸã€‚ç›®å‰å®ƒä¸»è¦æ˜¯æ‹¿åˆ° d3d9 çš„æ¸²æŸ“ç»“æžœå¹¶æ‹·è´åˆ° d3d11 çš„è´´å›¾ä¸Šã€‚å†é€šè¿‡å¢žè¡¥ç¨‹åºçš„æ¸²æŸ“ç®¡çº¿ç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚

å…³äºŽ d3d9 å’Œ d3d11 çš„ä¿¡æ¯äº¤äº’å¯ä»¥çœ‹ renderResource.cpp ä¸­çš„ SendSmbxBuffer_Internal å‡½æ•°ã€‚åœ¨ render.cpp ä¸­çš„ ExEngine::Render::Update å‡½æ•°ä¸­ï¼Œæ¯å¸§ä¸€å¼€å§‹ï¼ŒSendSmbxBuffer_Internal ä¼šå…ˆæ‰§è¡Œï¼Œå°† smbx çš„æ¸²æŸ“ç»“æžœæ‹¿åˆ°å¢žè¡¥ç¨‹åºä¸­ã€‚ç›®å‰æ˜¯ç›´æŽ¥æ¸²æŸ“å‡ºæ¥ï¼ŒåŽç»­å¯ä»¥åŠ äº›åŽå¤„ç†çš„é€‰é¡¹ï¼Œå†é€šè¿‡ msgBox å®žçŽ° teascript ä¸­è§¦å‘åŽå¤„ç†â€¦â€¦

renderResource.cpp å’Œ renderDevice.cpp çš„å…¶å®ƒéƒ¨åˆ†åˆ™ä¸»è¦æ˜¯åšä¸€äº›ç®¡çº¿è®¾å¤‡å’Œèµ„æºçš„åˆå§‹åŒ–å·¥ä½œã€‚

##### util

è¯¥æ–‡ä»¶å¤¹ä¸‹ä¸»è¦æ˜¯å­˜æ”¾ä¸€äº›å·¥å…·æ¨¡å—ã€‚

1. logger ç”¨äºŽè§„èŒƒåŒ–è¾“å‡º logã€‚log ä¼šè¾“å‡ºåˆ° main.exe åŒçº§ç›®å½•ä¸‹çš„ engine-ext.log ä¸­ã€‚å¦‚æžœæ˜¯ debug æ¨¡å¼ï¼Œåˆ™ä¸è¿‡æ»¤ logï¼Œå¦åˆ™åªä¼šè¾“å‡º RuntimeLog å’Œ Assert ä¿¡æ¯ã€‚
2. staticEventMgr äº‹ä»¶åˆ†å‘å™¨ã€‚å…·ä½“çš„äº‹ä»¶å£°æ˜Žåœ¨ event.h ä¸­
3. timeMgr æ—¶é—´ç®¡ç†å™¨ã€‚æä¾›èŽ·å–å½“å‰å¸§æ—¶é—´çš„æŽ¥å£ï¼Œä¹Ÿæä¾›å»¶è¿ŸæŸä¸ªå‡½æ•°åˆ° xx ç§’åŽæ‰§è¡Œçš„æŽ¥å£ã€‚
4. uuidGen UUID ç”Ÿæˆå™¨
5. strUtil å’Œ winapUtil æä¾›äº†ä¸€äº›å·¥å…·å‡½æ•°ï¼ˆå®½å­—ä¸²è½¬ std::stringã€èŽ·å–å½“å‰çª—å£åç­‰â€¦â€¦ï¼‰

#### å…¶å®ƒ

- smbxContext.cpp è¯¥æ–‡ä»¶ç”¨äºŽæ•´ç† smbx ä¸»ç¨‹åºçš„èµ„æºï¼ˆæ¯”å¦‚èŽ·å–åˆ°çš„ smbx çª—å£ï¼‰
- window.cpp è¯¥æ–‡ä»¶ç”¨äºŽåˆ›å»ºå¢žè¡¥ç¨‹åºçš„çª—å£ã€‚smbx æœ¬èº«çš„çª—å£ä¼šè¢«å¢žè¡¥ç¨‹åºè¦†ç›–ã€‚æˆ‘ä»¬æ‹¿åˆ° smbx çš„æ¸²æŸ“ç»“æžœæ¸²æŸ“åˆ°å¢žè¡¥ç¨‹åºæä¾›çš„çª—å£ä¸Šä»¥è§£å†³ä¸€äº› smbx æœ¬èº«çš„å›¾å½¢æ¸²æŸ“å’Œçª—å£æ‰€å­˜åœ¨çš„é—®é¢˜ã€‚

## ç†è®ºä¸Šçš„æ­£ç¡®è¿è¡Œæ•ˆæžœï¼š

![image-20250105223612564](./doc/img/README/image-20250105223612564.png)

ðŸ‘†å…¨å±ï¼Œä¸”æ— é”™è¯¯ç¼©æ”¾ï¼ˆä¸ºäº†è®© 4 : 3 çš„ç”»å¹…é€‚åº”ç»å¤§å¤šæ•°å®½å±ï¼Œç¨‹åºé‡Œç•™äº†é»‘è¾¹ï¼‰
