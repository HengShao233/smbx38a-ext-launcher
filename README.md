# SMBX 38A è¿è¡Œæ—¶åŠŸèƒ½å¢žè¡¥ç¨‹åº

è¯¥å·¥ç¨‹æœ‰ä¸¤ä¸ªç›®çš„ï¼š

1. è§„èŒƒåŒ– 38a ç‰ˆçš„ SMBX æ¸¸æˆä½“éªŒæµç¨‹ï¼Œæ–­æŽ‰åŽŸå¼•æ“Žæœ¬èº«çš„ç¼–è¾‘å™¨åŠŸèƒ½ï¼›
2. å¢žå¼º 38a ç‰ˆ SMBX æ¸¸æˆçš„ä½“éªŒï¼ˆå¼ºåˆ¶å…¨å±å¹¶ä¿®æ­£å…¨å±è¡¨çŽ°ï¼Œæ‰©å±•å›¾å½¢æ¸²æŸ“èƒ½åŠ›ï¼ˆæ¯”å¦‚æä¾›å±å¹•åŽå¤„ç†ï¼‰ç­‰åŠŸèƒ½ï¼‰

## çŽ¯å¢ƒé…ç½®

ç”±äºŽ SMBX 38a åªè¿è¡Œåœ¨ windows çŽ¯å¢ƒä¸­ï¼Œè¯¥é¡¹ç›®ä¸éœ€è¦è€ƒè™‘ä¸ºå…¶å®ƒè¿è¡ŒçŽ¯å¢ƒç”Ÿæˆå¯æ‰§è¡Œç¨‹åºã€‚ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œè¯¥é¡¹ç›®ä½¿ç”¨ VS 2019 ä½œä¸ºæž„å»ºç®¡ç†å·¥å…·ã€‚åœ¨æ‹‰å–äº†é¡¹ç›®ï¼ˆåŒ…æ‹¬ detours å­æ¨¡å—ï¼Œç‰¹æ®Šåœ°ï¼Œdetours ä½¿ç”¨ VS 2019 æž„å»ºï¼‰åŽï¼Œç›´æŽ¥æ‰“å¼€ smbx-enginex.sln å³å¯ã€‚

### ç¼–è¯‘è®¾ç½®

ç”±äºŽ C++ æ ‡å‡†å’Œå¹³å°å·¥å…·é›†ç‰ˆæœ¬é€‰æ‹©ä¸Šçš„å¤±ç­–ï¼Œç›®å‰è¯¥é¡¹ç›®åªèƒ½åœ¨ windows10 åŠä»¥ä¸Šçš„ x86 windows å°å¼æœºä¸Šç¼–è¯‘æˆåŠŸâ€¦â€¦ç”±äºŽ SMBX æºç¨‹åºä¸º 32 ä½ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä¹Ÿéœ€è¦å°†ç¼–è¯‘ç›®æ ‡è®¾ç½®ä¸º 32 ä½ã€‚

åœ¨ smbx-enginex.sln æ‰“å¼€æ— è¯¯åŽï¼Œé€ä¸ªç¼–è¯‘å„ä¸ªå­å·¥ç¨‹å³å¯ï¼š

![image-20250105210956584](./doc/img/README/image-20250105211039419.png)
![image-20250105211052550](./doc/img/README/image-20250105211052550.png)

### è¿è¡Œç”Ÿæˆç»“æžœ

è¯¥é¡¹ç›®çš„ç”Ÿæˆç»“æž„éœ€è¦ä¾é™„äºŽ SMBX æºç¨‹åºè¿è¡Œã€‚åœ¨ç¼–è¯‘å®ŒæˆåŽè¯·å°† smbx-enginex.sln åŒçº§ç›®å½•ä¸‹çš„ assets.zip ä¸Ž engine.zip è§£åŽ‹ç¼©åˆ°ç¼–è¯‘ç›®æ ‡ä¸‹çš„åŒåæ–‡ä»¶å¤¹ï¼š
![image-20250105211423362](./doc/img/README/image-20250105211423362.png)

**main.exe** ä¸ºé¡¹ç›®çš„å…¥å£ç¨‹åºï¼Œå…¶ä¼šå°è¯•å°† ./assets/main ä¸­çš„å…¥å£å…³å¡æä¾›ç»™ ./engine/engine-ext.exeã€‚ã€‚

## é¡¹ç›®ç»“æž„

è¯¥é¡¹ç›®ç”±å››ä¸ªå­å·¥ç¨‹ç»„æˆï¼š

- Detours ä¸ºå¾®è½¯æä¾›çš„ Hook å·¥å…·
- engine-extension ä¸ºå¢žè¡¥ç¨‹åºçš„ä¸»ä½“
- main ä¸ºå…¥å£ç¨‹åº
- redirection ç”¨äºŽå…³è” ./engine/engine.exe å’Œ ./engine-extension.dll

### Main

å­å·¥ç¨‹ main åªåšä¸¤ä»¶äº‹ï¼š

1. æ‹‰èµ· ./engine/engine.exeï¼ˆSMBX æºç¨‹åºï¼‰ï¼Œå¹¶å°†å…¥å£åœºæ™¯ä½œä¸ºå‚æ•°ä¼ é€’ç»™ SMBXã€‚
   ```cpp
   /* ... */
       if (CreateProcess(
           NULL,
           x,
           NULL,
           NULL,
           false,
           dwFlags,
           (LPVOID)chNewEnv,
           TEXT("./engine"),
           &si,
           &pi
       )) return 0;
   /* ... */
   ```
   
   

2. ä¸ºæ‹‰èµ·çš„ç¨‹åºè®¾ç½® ENGINE_PASSPORT çŽ¯å¢ƒå˜é‡ï¼ˆè¯¥çŽ¯å¢ƒå˜é‡ç”¨äºŽé˜»æ–­ç›´æŽ¥æ‰“å¼€ engine.exe çš„è¡Œä¸ºï¼Œè¯¥é˜»æ–­é€»è¾‘å†™åœ¨ redirection.dll ä¸­ï¼‰ã€‚
   ```cpp
   /* ... */
   	auto chNewEnv = new TCHAR[envSize]{ 0 };
       lpszCurrentVariable = (LPTSTR)chNewEnv;
       if (FAILED(StringCchCopy(lpszCurrentVariable, envSize, TEXT("ENGINE_PASSPORT=")))) return -3;
       lpszCurrentVariable += lstrlen(lpszCurrentVariable);
   /* ... */
   ```



### Redirection

å­å·¥ç¨‹ redirection ç”¨äºŽé“¾æŽ¥ engine.exe å’Œ engine-extension.dll

è¯¥é¡¹ç›®æ ¹ç›®å½•ä¸­çš„ engine.zip æ‰€æä¾›çš„ engine.exe æ˜¯æ‰“äº†è¡¥ä¸çš„ï¼ˆå¯ä»¥ç”¨ CFF Explorerï¼‰ï¼Œå®ƒè¢«åŽæœŸæ·»åŠ äº†ä¸€ä¸ªå¯¹åŒç›®å½•ä¸‹ redirection.dll æ‰€å¯¼å‡ºçš„åä¸º "_" çš„å‡½æ•°ä¾èµ–ï¼Œè¿™ä½¿å¾— engine.exe æ‰“å¼€æ—¶ä¼šå¯»æ‰¾ redirection.dll å¹¶è¿è¡Œå…¶å…¥å£å‡½æ•°ï¼ˆdllMainï¼‰ã€‚

redirection.dll ä¹Ÿåªå¹²äº†ä¸¤ä»¶äº‹ï¼š

1. æ£€æŸ¥å½“å‰è¿›ç¨‹çš„çŽ¯å¢ƒå˜é‡ ENGINE_PASSPORT æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œè‹¥ä¸æ»¡è¶³ç›´æŽ¥ç»ˆæ­¢è¯¥è¿›ç¨‹ã€‚
   ```cpp
   /* ... */
           TCHAR buffer[256];
           DWORD size = GetEnvironmentVariable(TEXT("ENGINE_PASSPORT"), buffer, 256);
           if (size == 4) {
               auto res = lstrcmp(buffer, TEXT("NONE"));
               if (res) ExitProcess(-3);
           }
   
           else if (size > 0 && size < sizeof(buffer)) {
               auto res = lstrcmp(buffer, PASSPORT);
               if (res) ExitProcess(-1);
           }
           else ExitProcess(-2);
   /* ... */
   ```

2. æ‹‰èµ· engine-extension.dll å¹¶è¿è¡Œå…¶å¯¼å‡ºçš„ engineStart() å‡½æ•°ã€‚

### Engine-extension

è¯¥å­å·¥ç¨‹ä¸ºå¢žè¡¥ç¨‹åºçš„ä¸»ä½“å·¥ç¨‹ã€‚å®ƒç”± redirection.dll æ‹‰èµ·ï¼Œå¹¶å¯¹ SMBX æºç¨‹åºï¼ˆ./engien/engine.exeï¼‰ä¸­ç›¸åº”çš„å‡½æ•°è¿›è¡Œ hook å¤„ç†ã€‚å…¶ä¸»ä½“é€»è¾‘å‚è§ main.cppï¼ˆè™½ç„¶ engine-extension çš„åˆå§‹åŒ–é€»è¾‘åº”è¯¥ä»Ž dllMain.cpp å¼€å§‹ï¼Œä¸è¿‡å¯¹äºŽå…·ä½“çš„ä¸šåŠ¡è¿˜æ˜¯å€¾å‘äºŽå‰¥ç¦»åˆå§‹ç»“æž„ï¼‰ã€‚

#### çº¿ç¨‹å¸ƒè®¾

ä¸ºäº†ä¸å½±å“ SMBX ä¸»ç¨‹åºçš„æ­£å¸¸è¿è¡Œï¼ŒEngine-extension ä¸ºå¢žè¡¥ç¨‹åºå•å¼€äº†ä¸€æ¡çº¿ç¨‹ï¼ˆä¸‹ç§°å¢žè¡¥çº¿ç¨‹ï¼‰ã€‚å¢žè¡¥çº¿ç¨‹å’Œ SMBX ä¸»çº¿ç¨‹çš„åå·®ä¸ä¼šè¶…è¿‡å¤§äºŽä¸€å¸§`ï¼ˆè‹¥æŸä¸ªçº¿ç¨‹å³å°†è¶…è¿‡åˆ™ä¼šè¢«é˜»å¡žï¼Œè¿™æ˜¯ç”±äºŽ D3D9 (smbx æ‰€ä½¿ç”¨) å’Œ D3D11 (å¢žè¡¥ç¨‹åºæ‰€ä½¿ç”¨) éƒ½æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼ŒEngine-extension ä¸ºäº†èŽ·å¾— D3D9 çš„æ¸²æŸ“ç»“æžœå¿…é¡»è¦åœ¨è¯¥å¤„è¿›è¡Œçº¿ç¨‹åŒæ­¥ï¼‰`ã€‚

ç†è®ºä¸Šè¯´ï¼Œæ‰€æœ‰çš„å¢žè¡¥ç¨‹åºé€»è¾‘éƒ½åº”è¯¥åœ¨å¢žè¡¥çº¿ç¨‹ä¸­è¿è¡Œã€‚ä¸ºäº†å®‰å…¨ä¸Šè€ƒè™‘ï¼Œåº”è¯¥å°½é‡å‡å°‘çº¿ç¨‹é—´çš„å¾€æ¥ã€‚

#### ç”Ÿå‘½å‘¨æœŸ

å¢žè¡¥ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸå®Œæ•´åœ°ç½—åˆ—åœ¨ main.cpp ä¸­ï¼š

```cpp
// å¤–æŒ‚å¼•æ“Žå¯åŠ¨ (è¿è¡Œåœ¨ä¸»çº¿ç¨‹)
void MainStart() { /*... æ­¤å¤„æ˜¯ hook é€»è¾‘å’Œå¢žè¡¥æ¨¡å—çš„åˆå§‹åŒ–å·¥ä½œ */ }

// smbx çš„ä¸»å¾ªçŽ¯, ç”± D3d9 çš„ Present å‡½æ•°å¸¦åŠ¨ (è¿è¡Œåœ¨ä¸»çº¿ç¨‹)
// æ‰€ä»¥ D3d9 è®¾å¤‡å®žä¾‹åˆ›å»ºå‰è¿™ä¸ªå‡½æ•°ä¸ä¼šè¿è¡Œ(æ‰€ä»¥å°±åˆšæ‰“å¼€ç¨‹åºè€Œè¨€ä¼šå»¶è¿Ÿä¸€äº›)
void SmbxUpdate() { /*...*/ }

// å¤–æŒ‚å¼•æ“Žä¸»å¾ªçŽ¯(å’Œ smbx ä¸»å¾ªçŽ¯ä¸åœ¨ä¸€ä¸ªçº¿ç¨‹, æ¶‰åŠåˆ°æ•°æ®äº¤äº’æ—¶æ³¨æ„ç«žäº‰é—®é¢˜) (è¿è¡Œåœ¨å¢žè¡¥çº¿ç¨‹)
void MainUpdate(float t) { /*... å¢žè¡¥æ¨¡å—çš„å¸§è½®è¯¢*/ }

// å¤–æŒ‚å¼•æ“Žé”€æ¯å‰æ‰§è¡Œ (è¿è¡Œåœ¨ä¸»çº¿ç¨‹)
void MainEnd() { /* ... è¿˜åŽŸ hook å’Œå¢žè¡¥æ¨¡å—çš„é”€æ¯*/ }
```

#### ä¸šåŠ¡æ¨¡å—

ç›®å‰å¢žè¡¥ç¨‹åºçš„ä¸»ä½“ä¸€å…±åˆ†ä¸ºå‡ ä¸ªå¤§ç±»ï¼ˆæŒ‰æ–‡ä»¶å¤¹åˆ†ï¼‰ï¼šhookã€renderã€utilï¼Œæ‰€æœ‰çš„ä¸šåŠ¡æ¨¡å—æ ¹æ®åŠŸèƒ½ä¸åŒåˆ†åˆ«ç½®äºŽå…¶ä¸­ã€‚

##### hook

hook ä¸»è¦ç®¡ç†å¯¹ smbx æºç¨‹åºä¸­å‡½æ•°çš„ hook å·¥ä½œã€‚ç›®å‰åª hook äº† d3d9 çš„æ‰€æœ‰æŽ¥å£ã€winapi çš„ GetMessage(...)ã€winapi çš„ MessageBoxW(...)ã€winapi çš„ ShowWindow(...)ã€‚

å…¶ä¸­ï¼š

- d3d9 ç”¨æ¥æ‹¦æˆªæ¸²æŸ“ä¿¡æ¯ã€‚
- ShowWindow ç”¨æ¥èŽ·å– smbx çš„ä¸»çª—å£
- MessageBoxW ç”¨æ¥æ‹¦æˆª smbx çš„æç¤ºå¼¹çª—ï¼ˆsmbx æ˜¯æ”¯æŒåœ¨ teascript ä¸­è°ƒç”¨å‡½æ•°å¼¹å‡º msgBox çš„ï¼Œå¹¶ä¸” msgBox ä¼šé˜»å¡ž smbx ä¸»çº¿ç¨‹çš„è¿è¡Œã€‚æˆ‘ä»¬å¯ä»¥èŽ·å¾— msgBox çš„ä¿¡æ¯å®žçŽ°åœ¨ teascript ä¸­è°ƒç”¨å¢žè¡¥ç¨‹åºçš„é€»è¾‘ï¼‰ã€‚

##### render

render æ–‡ä»¶å¤¹ä¸‹ä¸»è¦æ˜¯æ¸²æŸ“æ¨¡å—ï¼Œå…¶ä¸»ä½“å¯è§ render.cppã€‚åœ¨ render.cpp ä¸­ä¹Ÿæ˜Žç¡®åœ°åˆ—å‡ºäº†æ¸²æŸ“æ¨¡å—çš„ç”Ÿå‘½å‘¨æœŸã€‚ç›®å‰å®ƒä¸»è¦æ˜¯æ‹¿åˆ° d3d9 çš„æ¸²æŸ“ç»“æžœå¹¶æ‹·è´åˆ° d3d11 çš„è´´å›¾ä¸Šã€‚å†é€šè¿‡å¢žè¡¥ç¨‹åºçš„æ¸²æŸ“ç®¡çº¿ç»˜åˆ¶åˆ°å±å¹•ä¸Šã€‚

å…³äºŽ d3d9 å’Œ d3d11 çš„ä¿¡æ¯äº¤äº’å¯ä»¥çœ‹ renderResource.cpp ä¸­çš„ SendSmbxBuffer_Internal å‡½æ•°ã€‚åœ¨ render.cpp ä¸­çš„ ExEngine::Render::Update å‡½æ•°ä¸­ï¼Œæ¯å¸§ä¸€å¼€å§‹ï¼ŒSendSmbxBuffer_Internal ä¼šå…ˆæ‰§è¡Œï¼Œå°† smbx çš„æ¸²æŸ“ç»“æžœæ‹¿åˆ°å¢žè¡¥ç¨‹åºä¸­ã€‚ç›®å‰æ˜¯ç›´æŽ¥æ¸²æŸ“å‡ºæ¥ï¼ŒåŽç»­å¯ä»¥åŠ äº›åŽå¤„ç†çš„é€‰é¡¹ï¼Œå†é€šè¿‡ msgBox å®žçŽ° teascript ä¸­è§¦å‘åŽå¤„ç†â€¦â€¦

renderResource.cpp å’Œ renderDevice.cpp çš„å…¶å®ƒéƒ¨åˆ†åˆ™ä¸»è¦æ˜¯åšä¸€äº›ç®¡çº¿è®¾å¤‡å’Œèµ„æºçš„åˆå§‹åŒ–å·¥ä½œã€‚

##### util

è¯¥æ–‡ä»¶å¤¹ä¸‹ä¸»è¦æ˜¯å­˜æ”¾ä¸€äº›å·¥å…·æ¨¡å—ã€‚

1. logger ç”¨äºŽè§„èŒƒåŒ–è¾“å‡º logã€‚log ä¼šè¾“å‡ºåˆ° main.exe åŒçº§ç›®å½•ä¸‹çš„ engine-ext.log ä¸­ã€‚å¦‚æžœæ˜¯ debug æ¨¡å¼ï¼Œåˆ™ä¸è¿‡æ»¤ logï¼Œå¦åˆ™åªä¼šè¾“å‡º RuntimeLog å’Œ Assert ä¿¡æ¯ã€‚
2. staticEventMgr äº‹ä»¶åˆ†å‘å™¨ã€‚å…·ä½“çš„äº‹ä»¶å£°æ˜Žåœ¨ event.h ä¸­
3. timeMgr æ—¶é—´ç®¡ç†å™¨ã€‚æä¾›èŽ·å–å½“å‰å¸§æ—¶é—´çš„æŽ¥å£ï¼Œä¹Ÿæä¾›å»¶è¿ŸæŸä¸ªå‡½æ•°åˆ° xx ç§’åŽæ‰§è¡Œçš„æŽ¥å£ã€‚
4. uuidGen UUID ç”Ÿæˆå™¨
5. strUtil å’Œ winapUtil æä¾›äº†ä¸€äº›å·¥å…·å‡½æ•°ï¼ˆå®½å­—ä¸²è½¬ std::stringã€èŽ·å–å½“å‰çª—å£åç­‰â€¦â€¦ï¼‰

#### å…¶å®ƒ

- smbxContext.cpp è¯¥æ–‡ä»¶ç”¨äºŽæ•´ç† smbx ä¸»ç¨‹åºçš„èµ„æºï¼ˆæ¯”å¦‚èŽ·å–åˆ°çš„ smbx çª—å£ï¼‰
- window.cpp è¯¥æ–‡ä»¶ç”¨äºŽåˆ›å»ºå¢žè¡¥ç¨‹åºçš„çª—å£ã€‚smbx æœ¬èº«çš„çª—å£ä¼šè¢«å¢žè¡¥ç¨‹åºè¦†ç›–ã€‚æˆ‘ä»¬æ‹¿åˆ° smbx çš„æ¸²æŸ“ç»“æžœæ¸²æŸ“åˆ°å¢žè¡¥ç¨‹åºæä¾›çš„çª—å£ä¸Šå·²è§£å†³ä¸€äº› smbx æœ¬èº«çš„å›¾å½¢æ¸²æŸ“å’Œçª—å£æ‰€å­˜åœ¨çš„é—®é¢˜ã€‚

## ç†è®ºä¸Šçš„æ­£ç¡®è¿è¡Œæ•ˆæžœï¼š

![image-20250105223612564](./doc/img/README/image-20250105223612564.png)

ðŸ‘†å…¨å±ï¼Œä¸”æ— é”™è¯¯ç¼©æ”¾ï¼ˆä¸ºäº†è®© 4 : 3 çš„ç”»å¹…é€‚åº”ç»å¤§å¤šæ•°å®½å±ï¼Œç¨‹åºé‡Œç•™äº†é»‘è¾¹ï¼‰
